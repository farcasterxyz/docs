# 集线器（Hubs）

集线器是一个分布式服务器网络，负责存储和验证 Farcaster 数据。

计算机可通过运行特定软件成为 Farcaster 集线器。该软件会从以太坊区块链同步链上 Farcaster 数据，并从其他集线器获取链下数据。每个集线器都存储着完整的 Farcaster 数据副本，这些数据可通过 API 访问。

集线器支持您读写 Farcaster 数据，任何构建 Farcaster 应用的开发者都需要与之交互。用户可在笔记本电脑或云服务器上运行集线器，完整设置指南详见[此处](https://www.thehubble.xyz)。

## 设计架构

集线器首先从 Optimism 区块链上的 Farcaster 智能合约同步数据，由此获知每个用户的账户及其密钥信息。

Farcaster 消息的生命周期如下：

1. Alice 创建一条"Hello World!"消息
2. Alice（或其应用）使用账户密钥对消息进行签名
3. Alice（或其应用）将消息上传至集线器
4. 集线器验证消息有效性
5. 集线器通过 gossip 协议将消息传播至对等节点

![集线器架构图](/assets/hub.png)

### 验证机制

系统通过检查消息是否包含有效的账户密钥签名来验证 Alice 的消息。集线器还会确保消息符合其类型的规范要求，例如公共消息（cast）必须小于 320 字节。各类消息的具体规范详见[协议文档](https://github.com/farcasterxyz/protocol/blob/main/docs/SPECIFICATION.md)。

### 存储机制

在存储 Alice 的消息前，集线器会进行冲突检测。冲突可能由以下原因引发：

1. 该消息已存在于集线器
2. Alice 已发送删除该消息的后续指令
3. Alice 仅支付了 5000 条消息的存储费用，而当前为第 5001 条

系统采用 CRDT（无冲突复制数据类型）技术实现确定性异步冲突解决。例如当 Alice 存储空间不足时，其最早的消息将被自动移除。

### 数据同步

集线器通过两阶段流程同步数据：gossip 传播与差异同步。当集线器接收并存储消息后，会立即通过 gossip 协议广播至对等节点（采用 libp2p 的 gossipsub 协议，可能存在丢包）。随后集线器会定期随机选择对等节点进行差异同步，通过比对消息哈希的默克尔树高效定位丢失消息。

### 一致性保障

集线器具有强最终一致性特征。即使节点离线期间仍可接收写入请求，并在重新联网后安全恢复——这与区块链节点离线时无法确认交易的特点形成鲜明对比。但副作用是消息可能乱序到达，例如 Bob 对 Alice 的回复可能早于其"Hello World!"原消息显示。

### 节点评分

集线器会监控对等节点行为并进行评分。若节点出现拒绝有效消息、数据滞后或过度 gossip 等行为，可能被其他节点屏蔽。

### 实现方案

- [Hubble](https://www.thehubble.xyz) - 基于 TypeScript 和 Rust 的集线器实现

## 常见问题

**1. 为何需要运行集线器？**  
当您开发需要读写 Farcaster 数据的应用时，需部署自有集线器。

**2. 运行集线器有奖励吗？**  
Farcaster 不为集线器运营者提供奖励，且无相关计划。
