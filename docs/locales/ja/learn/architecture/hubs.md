# ハブ

ハブは、Farcaster データを保存および検証する分散型ネットワークのサーバー群です。

コンピュータはソフトウェアを実行して Farcaster ハブになることができます。これにより、Ethereum からオンチェーンの Farcaster データをダウンロードし、他のハブからオフチェーンの Farcaster データをダウンロードします。各ハブは、API を介してアクセスできるすべての Farcaster データのコピーを保存します。

ハブを使用すると、Farcaster にデータを読み書きでき、Farcaster アプリを構築する人は誰でもハブと通信する必要があります。誰でも自分のラップトップやクラウドサーバーでハブを実行できます。ハブのセットアップと実行に関する完全なガイドは[こちら](https://www.thehubble.xyz)で利用できます。

## 設計

ハブは、Optimism ブロックチェーン上の Farcaster コントラクトからデータを同期することから始まります。これにより、各ユーザーのアカウントとそのアカウントキーを認識します。

Farcaster メッセージのライフサイクルは次のようになります：

1. アリスが新しい「Hello World!」メッセージを作成します。
2. アリス（または彼女のアプリ）がアカウントキーでメッセージに署名します。
3. アリス（または彼女のアプリ）がメッセージをハブにアップロードします。
4. ハブがメッセージの有効性を確認します。
5. ハブがピアハブにゴシッププロトコルを使ってメッセージを送信します。

![Hub](/assets/hub.png)

### 検証

アリスのメッセージは、彼女のアカウントキーの 1 つからの有効な署名があるかどうかを確認することで検証されます。ハブはまた、メッセージがメッセージタイプの要件を満たしていることを確認します。例えば、公開メッセージまたは「キャスト」は 320 バイト未満でなければなりません。メッセージタイプの要件はプロトコル仕様に詳細に記載されています。

### ストレージ

次に、アリスのメッセージは競合がないか確認され、ハブに保存されます。競合は多くの理由で発生する可能性があります：

1. ハブがすでにメッセージのコピーを持っている。
2. ハブがアリスからこのメッセージを削除する後のメッセージを持っている。
3. アリスが 5000 キャストのレンタル料しか支払っておらず、これは彼女の 5001 番目のキャストである。

競合は CRDT を使用して決定論的かつ非同期に解決されます。例えば、アリスがメッセージを保存するスペースがない場合、彼女の最も古いメッセージが削除されます。

### レプリケーション

ハブはゴシップと差分同期の 2 段階プロセスを使用して同期します。ハブがメッセージを受信して保存すると、すぐにピアにゴシップします。ゴシップは libp2p の gossipsub プロトコルを使用して行われ、損失が発生する可能性があります。その後、ハブは定期的にランダムなピアを選択し、差分同期を実行してドロップされたメッセージを見つけます。差分同期プロセスは、メッセージハッシュのメルクリートライを比較して効率的にドロップされたメッセージを見つけます。

### 一貫性

ハブは強い最終的一貫性を持つと言われています。ハブが切断されても、書き込みが可能で、オンラインになると安全に回復します。これは、切断されたノードがトランザクションを確認できないブロックチェーンとは異なります。欠点は、メッセージが順不同で到着する可能性があることです。例えば、ボブのアリスへの返信が彼女の「Hello World」メッセージの前に表示されることがあります。

### ピアスコアリング

ハブはピアを監視し、その行動をスコアリングします。ピアが有効なメッセージを受け入れない場合、遅れる場合、またはゴシップが多すぎる場合、ピアによって無視される可能性があります。

### 実装

- [Hubble](https://www.thehubble.xyz) - Typescript と Rust で実装されたハブ

## FAQ

**1. なぜハブを実行する必要があるのですか？**

Farcaster データを読み書きするアプリを構築している場合、ハブが必要になるかもしれません。

**2. ハブを実行することで報酬はありますか？**

Farcaster はハブに報酬を提供しておらず、今後もその予定はありません。Farcaster 上で構築している会社である Warpcast は、ハブランナーに少額の報酬を提供していますが、将来的にこれを変更する可能性があります。
